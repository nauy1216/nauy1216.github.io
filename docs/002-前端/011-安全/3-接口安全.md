# 防篡改


### 为什么要防篡改

http 是一种无状态的协议, 服务端并不知道客户端发送的请求是否合法, 也并不知道请求中的参数是否正确。
举个栗子, 现在有个充值的接口, 调用给用户对应的余额

```js
http://localhost/api/user/recharge?user_id=1001&amount=10
```
1. 给指定id的用户加上10块钱的余额
2. 如果用户id被篡改,余额参数被篡改,也就是说,可以给任何用户加余额



### 如何防篡改 - 设计sign

1. 客户端: **每次请求客户端都带一个 sign 参数给服务端, 这个所谓的 sign 就是一个字符串**
2. 服务端: **每次处理请求之前先验证 sign 是否合法, 如果不合法就不处理**



### 生成 sign 和验证 sign: 怎么生成和验证, 需要客户端和服务端约定好

1. 客户端生成 sign: 可使用 **公私钥非对称加密** 的方式, 也可以使用计算字符串 md5 或者 hash 值的方式, 这个被加密的字符串最好不是固定的,取时间戳, 请求参数等就可以, 每次客户端把生成sign传递给服务端。
2. 服务端根据约定好的算法验证sign是否正确就可以。


不一定非得叫 sign 这么个名字, 就是个请求参数的名称而已。
```js
http://localhos/api/assets/recharge?id=1001&amount=10&sign=asdfasdf6sdfs87f67
```



# 防重放



### 为什么要防重放

防重放也叫*防复用*, 简单来说, 就是我获取到这个请求的信息之后, 我什么也不改, 我就拿着接口的参数去重复请求这个充值的接口。
也就是说我的请求是合法的, 因为所有参数都是跟合法请求一模一样的。 也就是说: 服务端的 sign 验证一定能通过, 但是此时, 我可以去重复请求这个充值的接口, 也就是我能够重复的充值(假设这个接口没有做其他逻辑处理,调用就能充值,我只是假设, 别抬杠), 调用一次加 10 块钱余额, 2次就是20...这就不合理了。



### 防重放设计

> 客户端在请求中添加两个参数
1. 添加一个随机不重复的字符串参数 比如uuid 至于怎么让他不重复,可以考虑拼接时间戳,md5随机数等
2. 添加一个请求时间的参数 如 request_time 值就是发送请求时的 时间戳

> 服务端接收到请求之后
1. 去缓存里中查找 uuid 这个参数对应的值是否存在
2. 如果不存在: 就把这个uuid的值保存到缓存中, 记录这个请求
3. 如果已存在: 存在那就证明, 已经请求过一次了, 就不处理这个请求了

缓存可以是redis也可以是其他存储介质,应该给缓存设计过期时间,因为请求多了,就会有大量的 uuid 保存在缓存中。



###  课余作业

1. 学习微信小程序api的设计