> 参考文档
- https://www.html5rocks.com/zh/tutorials/internals/howbrowserswork/


# 浏览器的主要功能
- 向服务器发出请求
- 在浏览器窗口展示网络资源

# W3C
浏览器解释并显示 HTML 文件的方式是在 HTML 和 CSS 规范中指定的。这些规范由网络标准化组织 W3C（万维网联盟）进行维护。

# 浏览器的高层结构
- 1、用户界面 - 包括地址栏、前进/后退按钮、书签菜单等。除了浏览器主窗口显示的您请求的页面外，其他显示的各个部分都属于用户界面。
- 2、浏览器引擎 - 在用户界面和呈现引擎之间传送指令。
- 3、呈现引擎 - 负责显示请求的内容。如果请求的内容是 HTML，它就负责解析 HTML 和 CSS 内容，并将解析后的内容显示在屏幕上。
- 4、网络 - 用于网络调用，比如 HTTP 请求。其接口与平台无关，并为所有平台提供底层实现。
- 5、用户界面后端 - 用于绘制基本的窗口小部件，比如组合框和窗口。其公开了与平台无关的通用接口，而在底层使用操作系统的用户界面方法。
- 6、JavaScript 解释器。用于解析和执行 JavaScript 代码。
- 7、数据存储。这是持久层。浏览器需要在硬盘上保存各种数据，例如 Cookie。新的 HTML 规范 (HTML5) 定义了“网络数据库”，这是一个完整（但是轻便）的浏览器内数据库。


![浏览器的主要组件](./image/1.png)

### 呈现引擎
Firefox 使用的是 Gecko，这是 Mozilla 公司“自制”的呈现引擎。而 Safari 和 Chrome 浏览器使用的都是 WebKit。
> 呈现引擎的基本流程
- 1、从网络层获取请求文档的内容
- 2、解析html文档生成DOM树
- 3、解析css生成CSSOM树
- 4、DOM树和CSSOM树一起构建成Render树
- 5、Render树进行layout，为每一个节点分配一个在屏幕上的坐标和尺寸。
- 6、Render树进行paint，呈现引擎会遍历Render树由用户界面后端层将每个节点绘制出来。

> 注意
- 呈现引擎展示内容是一个*渐进*的过程，不必等到整个HTML文档解析完成，就会开始构建Render树和设置布局。
- 在不断接受和处理来自网络的其他内容的同时，呈现引擎回将部分内容解析并显示出来。

> 呈现引擎的基本流程

![呈现引擎的基本流程](./image/21-03-14-2.png)

> 主流程

![主流程](./image/210314-2.png)


# 解析（parse）
> 目的

解析文档是指将文档转化成为有意义的结构，也就是可让代码理解和使用的结构。

> 解析的过程可以分成两个子过程：*词法分析*和*语法分析*
- 词法分析
词法分析是将*输入内容（字符串）*分割成大量标记的过程。标记是语言中的词汇，即构成内容的单位。

- 词法分析器
负责将输入内容分解成一个个有效标记。

- 解析器
负责根据语言的语法规则分析文档的结构，从而构建解析树。

> 从源文档到解析树的过程

![主流程](./image/210314-3.png)


# HTML解析器
> 目的

将HTML文档标记成解析树。

> DOM

解析器的输出“解析树”是由DOM元素和属性节点构成的树结构。
DOM是文档对象模型 (Document Object Model) 的缩写。它是 HTML 文档的对象表示，同时也是外部内容（例如 JavaScript）与 HTML 元素之间的接口。

# CSS解析器

###  WebKit CSS 解析器
将 CSS 文件解析成 StyleSheet 对象，且每个对象都包含 CSS 规则。CSS 规则对象则包含选择器和声明对象，以及其他与 CSS 语法对应的对象。

![主流程](./image/210314-4.png)


# 处理脚本和样式表的顺序

### 脚本
- 网络的模型是同步的。网页作者希望解析器遇到 `<script>` 标记时立即解析并执行脚本。文档的解析将停止，直到脚本执行完毕。如果脚本是外部的，那么解析过程会停止，直到从网络同步抓取资源完成后再继续。此模型已经使用了多年，也在 HTML4 和 HTML5 规范中进行了指定。

- 使用`defer`, 将脚本延迟到文档解析结束后才执行。

- 使用`async`, 脚本异步加载执行。

###  预解析
- 在执行脚本时，其他线程会解析文档的其余部分，找出并加载需要通过网络加载的其他资源。
- 预解析器不会修改 DOM 树，而是将这项工作交由主解析器处理；预解析器只会解析外部资源（例如外部脚本、样式表和图片）的引用。


### 样式表
脚本在文档解析阶段会请求样式信息。如果当时还没有加载和解析样式，脚本就会获得错误的回复，这样显然会产生很多问题。
Firefox 在样式表加载和解析的过程中，会禁止所有脚本。而对于 WebKit 而言，仅当脚本尝试访问的样式属性可能受尚未加载的样式表影响时，它才会禁止该脚本。
>  css 加载会造成阻塞吗 ？
DOM 和 CSSOM 通常是并行构建的,所以 CSS 加载不会阻塞 DOM 的解析。由于 Render Tree 是依赖于 DOM Tree 和 CSSOM Tree 的,CSS 加载会阻塞 Dom 的渲染。




# 浏览器存储数据的几种方式
- cookie
- localStorage和sessionStorage
- indexDB

> cookie和storage的区别？
- 存储的数据量不同，storage能存更多的数据
- cookie访问或者写入指定数据需要自己封装方法，storage浏览器已经提供了
- cookie在http请求时会携带给服务器，storage不会
- cookie能手动设置失效时间，sessionStorage是会话级的存储页面关闭就失效了，localstorage是永久级
- cookie可以在不同的二级域名下共享，storage不能
- cookie能设置指定的path, 对指定的路径下才能访问到cookie









